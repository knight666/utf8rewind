<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>utf8rewind: utf8rewind</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">utf8rewind
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="utf8rewind_8h.html"><span>C&#160;interface</span></a></li>
      <li><a href="classutf8rewind_1_1_utf8_string.html"><span>String</span></a></li>
      <li><a href="classutf8rewind_1_1_utf8_string_1_1iterator.html"><span>String&#160;iterator</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="namespaceutf8rewind.html">utf8rewind</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#introduction">Introduction</a></li>
<li class="level1"><a href="#why-utf8">Why UTF-8?</a></li>
<li class="level1"><a href="#why-not-utf16">Why not UTF-16?</a></li>
<li class="level1"><a href="#examples">Examples</a><ul><li class="level2"><a href="#example-changes">Changes to existing code</a></li>
<li class="level2"><a href="#example-user-input">Dealing with user input</a></li>
<li class="level2"><a href="#example-display">Displaying Unicode usernames</a></li>
</ul>
</li>
<li class="level1"><a href="#building">Building utf8rewind</a><ul><li class="level2"><a href="#integration">Integrating with your own project</a></li>
</ul>
</li>
<li class="level1"><a href="#helping-out">Helping out</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="introduction"></a>
Introduction</h1>
<p><code><a class="el" href="namespaceutf8rewind.html">utf8rewind</a></code> is a C library designed to extend default string handling functions in order to add support for UTF-8 encoded text. Besides providing functions to deal with UTF-8 encoded text, it also provides functions for converting to and from UTF-16 encoded text, the default on Windows.</p>
<p>For a full summary of the interface, please click <a class="el" href="utf8rewind_8h.html">here</a>.</p>
<p>For inquiries, complaints and patches, please contact <code>{quinten}{lansu} {at} {gmail}.{com}</code>. Remove the brackets to get a valid e-mail address.</p>
<h1><a class="anchor" id="why-utf8"></a>
Why UTF-8?</h1>
<p>UTF-8 encoded Unicode accounts for <a href="http://googleblog.blogspot.nl/2012/02/unicode-over-60-percent-of-web.html">over 60 percent of the web</a>. And with good reason! Because UTF-8 is completely backwards-compatible with ASCII, developers only need to change code dealing with codepoints. UTF-8 can encode the full range of Unicode codepoints in a maximum of six bytes per codepoint. However, because most text tends to be the Latin alphabet mixed with special characters, the common case is strings not much longer than pure ASCII.</p>
<h1><a class="anchor" id="why-not-utf16"></a>
Why not UTF-16?</h1>
<p>UTF-16 encoding solves the same problems as UTF-8, but in a different way. UTF-16 is not backwards-compatible with ASCII, resulting in invalid codepoints being encountered when the string is treated as ASCII. As a result, all code dealing with strings must be changed in order to handle these new strings. This can be seen in the changes made in the C strings API:</p>
<table class="doxtable">
<tr>
<th>Description </th><th>ASCII </th><th>UTF-16  </th></tr>
<tr>
<td>Get the length of a string </td><td>strlen </td><td>wcslen </td></tr>
<tr>
<td>Copy a string to another </td><td>strcpy </td><td>wcscpy </td></tr>
<tr>
<td>Append to a string </td><td>strcat </td><td>wcscat </td></tr>
<tr>
<td>Convert to lowercase </td><td>tolower </td><td>towlower </td></tr>
</table>
<p>Converting a project to use UTF-16 after the fact is a serious endeavour that touches <em>all</em> code dealing with strings. On the other hand, changing existing code to use UTF-8 only deals with codepoint processing.</p>
<h1><a class="anchor" id="examples"></a>
Examples</h1>
<h2><a class="anchor" id="example-changes"></a>
Changes to existing code</h2>
<p>Suppose you maintain a client application written in C. In order for clients to login, the application needs to check their credentials. This is accomplished by the following function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> Login_CheckCredentials(<span class="keyword">const</span> <span class="keywordtype">char</span>* username, <span class="keyword">const</span> <span class="keywordtype">char</span>* password)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* salt;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* hashed_password;</div>
<div class="line">    <span class="keywordtype">char</span> verify_password[256];</div>
<div class="line">    <span class="keywordtype">char</span> hashed_verify_password[256];</div>
<div class="line"></div>
<div class="line">    memset(verify_password, 0, 256);</div>
<div class="line">    <span class="comment">/* For the purposes of brevity, ignore the fact</span></div>
<div class="line"><span class="comment">    that this is a terrible way to generate a salt,</span></div>
<div class="line"><span class="comment">    because it has insufficient entropy. */</span></div>
<div class="line">    salt = md5(username);</div>
<div class="line">    hashed_password = md5(password);</div>
<div class="line">    strcat(verify_password, hashed_password);</div>
<div class="line">    strcat(verify_password, salt);</div>
<div class="line"></div>
<div class="line">    memset(hashed_verify_password, 0, 256);</div>
<div class="line">    strcpy(hashed_verify_password, md5(verify_password));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> Database_CheckLogin(username, hashed_verify_password);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now we want to improve our security by allowing the full range of Unicode in the passwords by using UTF-8 encoding.</p>
<p>What would we have to change? The answer is: nothing.</p>
<p>A password like "M&ocirc;ntiPyth&ocirc;nikdenH&ocirc;lieGr&acirc;ilen" would be encoded as "M\xF8Pyth\xF8denH\xF8Gr\xE4en", meaning the calls to <code>strcat</code> and <code>strcpy</code> would still work as intended. The password can be treated as ASCII without changing the code.</p>
<p>When converting your project to use UTF-8, you only have to worry about two surface area's: input and display. Let's look at those separately.</p>
<h2><a class="anchor" id="example-user-input"></a>
Dealing with user input</h2>
<p>Continuing with the previous example, the old password field accepted only ASCII input:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> g_PasswordInputMaximum = 255;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> g_PasswordInput[g_PasswordInputMaximum + 1];</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> PasswordField_EnterCharacter(<span class="keywordtype">char</span> input)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> text_input[2];</div>
<div class="line">    text_input[0] = input;</div>
<div class="line">    text_input[1] = 0;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (strlen(g_PasswordInput) + 1 &gt; g_PasswordInputMaximum)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    strcat(g_PasswordInput, text_input);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment --><p>We'll have to make sure that we provide UTF-32 codepoints instead:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> PasswordField_EnterCharacter(<a class="code" href="utf8rewind_8h.html#a1fe7d84695f910c23ceca80b12983323">unicode_t</a> input)</div>
</div><!-- fragment --><p>This can be accomplished using a simple cast, because all Unicode codepoints fit in a <code>unicode_t</code> type.</p>
<p>Next, we'll have to increase the size of the <code>text_input</code> string in order to accommodate the conversion of the codepoint to UTF-8:</p>
<div class="fragment"><div class="line"><span class="keywordtype">char</span> text_input[16];</div>
<div class="line">memset(text_input, 0, 16);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="utf8rewind_8h.html#ab936e1848e79cdff95c834a294a7539c">utf8encode</a>(input, text_input, 16) &lt;= 0)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Because the codepoint can consist of multiple characters, we'll have to change the check to see if we're not overflowing the password input string:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (strlen(g_PasswordInput) + strlen(text_input) &gt; g_PasswordInputMaximum)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Finally, putting it all together:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> g_PasswordInputMaximum = 255;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> g_PasswordInput[g_PasswordInputMaximum + 1];</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> PasswordField_EnterCharacter(<a class="code" href="utf8rewind_8h.html#a1fe7d84695f910c23ceca80b12983323">unicode_t</a> input)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> text_input[16];</div>
<div class="line">    memset(text_input, 0, 16);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="utf8rewind_8h.html#ab936e1848e79cdff95c834a294a7539c">utf8encode</a>(input, text_input, 16) &lt;= 0)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (strlen(g_PasswordInput) + strlen(text_input) &gt; g_PasswordInputMaximum)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    strcat(g_PasswordInput, text_input);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
</div><!-- fragment --><p>With a few changes, the password field now accepts UTF-8 input. The benefit here is that we didn't need to change the algorithm itself, only the input had to be converted.</p>
<h2><a class="anchor" id="example-display"></a>
Displaying Unicode usernames</h2>
<p>One problem remains: the user may be able to <em>enter</em> Unicode characters in text fields, but they won't show up right.</p>
<p>Let's look at the offending function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> InputField_Draw(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keyword">const</span> <span class="keywordtype">char</span>* text)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> i;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* src = text;</div>
<div class="line">    </div>
<div class="line">    FontBatch_Start(<span class="stringliteral">&quot;Arial20&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; strlen(text); ++i)</div>
<div class="line">    {</div>
<div class="line">        FontBatch_AddCharacter(*src);</div>
<div class="line">        </div>
<div class="line">        src++;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    FontBatch_End();</div>
<div class="line">    FontBatch_Draw(x, y);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The first thing that will have to change is that <code>FontBatch_AddCharacter</code> should accept UTF-32 codepoints. Fortunately, that change is backwards-compatible:</p>
<div class="fragment"><div class="line">FontBatch_AddCharacter((<a class="code" href="utf8rewind_8h.html#a1fe7d84695f910c23ceca80b12983323">unicode_t</a>)*src);</div>
</div><!-- fragment --><p>Next, we'll have to treat the input as UTF-8 encoded text. We'll have to read codepoints one-by-one.</p>
<div class="fragment"><div class="line"><a class="code" href="utf8rewind_8h.html#a1fe7d84695f910c23ceca80b12983323">unicode_t</a> codepoint;</div>
<div class="line"><span class="keywordtype">size_t</span> i;</div>
<div class="line"><span class="keywordtype">int</span> offset;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* src = text;</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="utf8rewind_8h.html#ab34ee783c503a651da04128ec8086b4b">utf8len</a>(text); ++i)</div>
<div class="line">{</div>
<div class="line">    offset = <a class="code" href="utf8rewind_8h.html#a4d0c2482832b035a189e96a0d3d80e4c">utf8decode</a>(src, &amp;codepoint);</div>
<div class="line">    <span class="keywordflow">if</span> (offset &lt;= 0)</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    src += offset;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Putting it all together again:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> InputField_Draw(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keyword">const</span> <span class="keywordtype">char</span>* text)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="utf8rewind_8h.html#a1fe7d84695f910c23ceca80b12983323">unicode_t</a> codepoint;</div>
<div class="line">    <span class="keywordtype">size_t</span> i;</div>
<div class="line">    <span class="keywordtype">int</span> offset;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* src = text;</div>
<div class="line">    </div>
<div class="line">    FontBatch_Start(<span class="stringliteral">&quot;Arial20&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="utf8rewind_8h.html#ab34ee783c503a651da04128ec8086b4b">utf8len</a>(text); ++i)</div>
<div class="line">    {</div>
<div class="line">        offset = <a class="code" href="utf8rewind_8h.html#a4d0c2482832b035a189e96a0d3d80e4c">utf8decode</a>(src, &amp;codepoint);</div>
<div class="line">        <span class="keywordflow">if</span> (offset &lt;= 0)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        FontBatch_AddCharacter(codepoint);</div>
<div class="line">        </div>
<div class="line">        src += offset;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    FontBatch_End();</div>
<div class="line">    FontBatch_Draw(x, y);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="building"></a>
Building utf8rewind</h1>
<p>Use <a href="http://code.google.com/p/gyp/">GYP</a> to generate a project, like so: </p>
<pre class="fragment">tools/gyp/gyp --depth --format=msvs2010 utf8rewind.gyp
</pre><p>After generating a solution, build and run the "tests" project. Verify that all tests pass on your system before continuing.</p>
<dl class="section note"><dt>Note</dt><dd>The project has only been tested as compiling and running using Visual Studio 2010 on Windows, but GYP should generate workable output for other platforms as well.</dd></dl>
<h2><a class="anchor" id="integration"></a>
Integrating with your own project</h2>
<p>The recommended way to integrate <code><a class="el" href="namespaceutf8rewind.html">utf8rewind</a></code> is to link to the static library you compiled. Of course, because the library consists of only two files, the header and source can also be included directly.</p>
<h1><a class="anchor" id="helping-out"></a>
Helping out</h1>
<p>As a user, you can help the project in a number of ways, in order of difficulty:</p>
<p><b>Use it</b> - Interface designers such as myself often have very different ideas about usability than those actually using it. By using the library, you are helping the project spread and could potentially improve it by taking your project into consideration.</p>
<p><b>Spread the word</b> - If you find <code><a class="el" href="namespaceutf8rewind.html">utf8rewind</a></code> useful, recommend it to your friends and coworkers.</p>
<p><b>Complain</b> - No library is perfect and <code><a class="el" href="namespaceutf8rewind.html">utf8rewind</a></code> is no exception. If you find a fault but lack the means (time, resources, etc.) to fix it, sending complaints to the proper channels can help the project out a lot.</p>
<p><b>Write a failing test</b> - If a feature is not working as intended, you can prove it by writing a failing test. By sending the test to us, we can make the adjustments necessary for it to pass.</p>
<p><b>Write a patch</b> - Patches include a code change that help tests to pass. A patch must always include a set of tests that fail to pass without the patch. All patches will be reviewed and possibly cleaned up before being accepted. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Apr 24 2014 08:48:05 for utf8rewind by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
