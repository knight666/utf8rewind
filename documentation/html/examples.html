<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.12"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>utf8rewind: Examples</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">utf8rewind
   &#160;<span id="projectnumber">1.5.1</span>
   </div>
   <div id="projectbrief">System library for processing UTF-8 encoded text</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('examples.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Examples </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#example-changes">Changes to existing code</a></li>
<li class="level1"><a href="#example-user-input">Dealing with user input</a></li>
<li class="level1"><a href="#example-display">Displaying Unicode text</a></li>
<li class="level1"><a href="#example-users">Comparing usernames in a case-insensitive manner</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="example-changes"></a>
Changes to existing code</h1>
<p>Suppose you maintain a client-server application written in C. The client connects to a central server and allows the user to manipulate the database in some way. In order for clients to login, the server needs to check their credentials. This is accomplished by the client hashing the specified password with a salt before sending it over to the server:</p>
<div class="fragment"><div class="line">uint8_t Login_CheckCredentials(<span class="keyword">const</span> <span class="keywordtype">char</span>* username, <span class="keyword">const</span> <span class="keywordtype">char</span>* password)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* salt;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* hashed_password;</div><div class="line">    <span class="keywordtype">char</span> verify_password[256];</div><div class="line">    <span class="keywordtype">char</span> hashed_verify_password[256];</div><div class="line"></div><div class="line">    <span class="comment">// For the purposes of brevity, ignore the fact that this is a</span></div><div class="line">    <span class="comment">// terrible way of generating a salt.</span></div><div class="line">    memset(verify_password, 0, <span class="keyword">sizeof</span>(verify_password));</div><div class="line">    strcpy(verify_password, md5(password));</div><div class="line">    strcat(verify_password, md5(username));</div><div class="line"></div><div class="line">    memset(hashed_verify_password, 0, <span class="keyword">sizeof</span>(hashed_verify_password));</div><div class="line">    strcpy(hashed_verify_password, md5(verify_password));</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> Database_CheckLogin(username, hashed_verify_password);</div><div class="line">}</div></div><!-- fragment --><p>We want to improve the security of the application by allowing the full range of Unicode code points in the passwords. We can accomplish this by encoding the code points using UTF-8. The beauty of this change is that the password algorithm does <em>not</em> have to be modified. Because all functions already work on <code>char</code> arrays, we can encode Unicode as UTF-8, but treat the string as valid ASCII.</p>
<p>A password like "M&ocirc;ntiPyth&ocirc;nikdenH&ocirc;lieGr&acirc;ilen" would be encoded as </p><pre class="fragment">"M\xC3\xB4Pyth\xC3\xB4" "denH\xC3\xB4Gr\xC3\xA2" "en"
</pre><p>which is backwards-compatible with ASCII. Calls to <code>strcpy</code> and <code>strcat</code> still work as expected, because the string does not contain NUL-terminators (<code>\0</code>), except to signify the end of data.</p>
<p>When converting your project to work with UTF-8 encoded text, there are only two surface areas you will have to concern yourself with: input and display.</p>
<p>We'll look at these individually.</p>
<h1><a class="anchor" id="example-user-input"></a>
Dealing with user input</h1>
<p>Continuing with our previous example, the password field in the client application only accepted ASCII. This is how the password field is currently implemented:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">size_t</span> g_PasswordInputMaximum = 255;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> g_PasswordInput[256];</div><div class="line"></div><div class="line">uint8_t PasswordField_EnterCharacter(<span class="keywordtype">char</span> input)</div><div class="line">{</div><div class="line">    <span class="keywordtype">char</span> text_input[2];</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((strlen(g_PasswordInput) + 1) &gt; g_PasswordInputMaximum)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">    }</div><div class="line"></div><div class="line">    text_input[0] = input;</div><div class="line">    text_input[1] = 0;</div><div class="line"></div><div class="line">    strcat(g_PasswordInput, text_input);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">}</div></div><!-- fragment --><p>What we want to do is make sure the password field can accept Unicode input. To that end, we'll change the input type to <a class="el" href="group__types.html#gae128fe5bd9e57be736e64d3638229988" title="UTF-32 encoded code point. ">unicode_t</a>, which can encode every valid Unicode code point.</p>
<div class="fragment"><div class="line">uint8_t PasswordField_EnterCharacter(<a class="code" href="group__types.html#gae128fe5bd9e57be736e64d3638229988">unicode_t</a>* input, <span class="keywordtype">size_t</span> inputSize)</div></div><!-- fragment --><p>Something that surprises many people working with Unicode is that although UTF-32 can contain all possible valid code points, Unicode <em>itself</em> is a variable-length encoding! For instance, consider a string like "U+0399
U+0308" (GREEK CAPITAL LETTER IOTA and COMBINING DIAERESIS). Although each encodes a separate code point, they can be combined (normalized) into U+03AA (GREEK CAPITAL LETTER IOTA WITH DIALYTIKA). This means that splitting the string after U+0399 is not valid, as it would change the meaning of the encoded text.</p>
<p>There are also many instances of code points that can be combined when rendering, but aren't explicitly listed in the Unicode database. This allowed the Unicode Consortium to encode many more characters without taking up space in the database. The downside for developers is of course that it can be difficult to anticipate how much space will be required to store any particular amount of text.</p>
<p>Back to our example.</p>
<p>Every location that calls <code>PasswordField_EnterCharacter</code> will have to cast the parameter to <a class="el" href="group__types.html#gae128fe5bd9e57be736e64d3638229988" title="UTF-32 encoded code point. ">unicode_t</a>, but luckily this is backwards-compatible. All values in ASCII (0x00 to 0x7F) encode the same characters in Unicode.</p>
<p>Inside the function, we'll want to convert the UTF-32 code point to UTF-8. To that end, we'll use <a class="el" href="group__public.html#ga325b2612f0a2afdacb81d5e6831bd43b" title="Convert a UTF-32 encoded string to a UTF-8 encoded string. ">utf32toutf8</a>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">char</span>* text_input = NULL;</div><div class="line"><span class="keywordtype">size_t</span> text_input_size;</div><div class="line"><span class="keywordtype">size_t</span> converted_size;</div><div class="line">int32_t errors = <a class="code" href="group__errors.html#gac7f8a18ca0ca9ebb357b2e7b9c527cc3">UTF8_ERR_NONE</a>;</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> ((text_input_size = <a class="code" href="group__public.html#ga325b2612f0a2afdacb81d5e6831bd43b">utf32toutf8</a>(input, inputSize, NULL, 0, &amp;errors)) == 0 ||</div><div class="line">    errors != <a class="code" href="group__errors.html#gac7f8a18ca0ca9ebb357b2e7b9c527cc3">UTF8_ERR_NONE</a>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">goto</span> cleanup;</div><div class="line">}</div><div class="line"></div><div class="line">text_input = (<span class="keywordtype">char</span>*)malloc(text_input_size + 1);</div><div class="line"><span class="keywordflow">if</span> (text_input == NULL)</div><div class="line">{</div><div class="line">    <span class="keywordflow">goto</span> cleanup;</div><div class="line">}</div><div class="line">text_input[text_input_size] = 0;</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> (<a class="code" href="group__public.html#ga325b2612f0a2afdacb81d5e6831bd43b">utf32toutf8</a>(input, inputSize, text_input, text_input_size, &amp;errors) == 0 ||</div><div class="line">    errors != <a class="code" href="group__errors.html#gac7f8a18ca0ca9ebb357b2e7b9c527cc3">UTF8_ERR_NONE</a>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">goto</span> cleanup;</div><div class="line">}</div></div><!-- fragment --><p>We first determine the length of the input before we allocate memory for it. This way, we ensure that we're protected from buffer-overflow attacks. If you're not too keen on dynamic memory allocations, you could limit the input sequence to six code points, which would require a maximum of 32 bytes to encode.</p>
<p>It's good practice to always check the error code after each call. However, never explicitly check for any particular error code! <code>utf8rewind</code> may introduce new error codes on every release, so you should check if the error code does <em>not</em> equal <code>UTF8_ERR_NONE</code>.</p>
<p>Because the converted string can now consist of more than one byte, we'll have to change the check to see if we're out of bounds of the password input array.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> ((strlen(g_PasswordInput) + strlen(text_input)) &gt; g_PasswordInputMaximum)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>The rewritten version is now fully compatible with Unicode.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">size_t</span> g_PasswordInputMaximum = 255;</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> g_PasswordInput[256];</div><div class="line"></div><div class="line">uint8_t PasswordField_EnterCharacter(<a class="code" href="group__types.html#gae128fe5bd9e57be736e64d3638229988">unicode_t</a> input)</div><div class="line">{</div><div class="line">    uint8_t result = 1;</div><div class="line">    <span class="keywordtype">char</span>* text_input = NULL;</div><div class="line">    <span class="keywordtype">size_t</span> text_input_size;</div><div class="line">    <span class="keywordtype">size_t</span> converted_size;</div><div class="line">    int32_t errors = <a class="code" href="group__errors.html#gac7f8a18ca0ca9ebb357b2e7b9c527cc3">UTF8_ERR_NONE</a>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((text_input_size = <a class="code" href="group__public.html#ga325b2612f0a2afdacb81d5e6831bd43b">utf32toutf8</a>(input, inputSize, NULL, 0, &amp;errors)) == 0 ||</div><div class="line">        errors != <a class="code" href="group__errors.html#gac7f8a18ca0ca9ebb357b2e7b9c527cc3">UTF8_ERR_NONE</a>)</div><div class="line">    {</div><div class="line">        result = 0;</div><div class="line"></div><div class="line">        <span class="keywordflow">goto</span> cleanup;</div><div class="line">    }</div><div class="line"></div><div class="line">    text_input = (<span class="keywordtype">char</span>*)malloc(text_input_size + 1);</div><div class="line">    <span class="keywordflow">if</span> (text_input == NULL)</div><div class="line">    {</div><div class="line">        result = 0;</div><div class="line"></div><div class="line">        <span class="keywordflow">goto</span> cleanup;</div><div class="line">    }</div><div class="line">    text_input[text_input_size] = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__public.html#ga325b2612f0a2afdacb81d5e6831bd43b">utf32toutf8</a>(input, inputSize, text_input, text_input_size, &amp;errors) == 0 ||</div><div class="line">        errors != <a class="code" href="group__errors.html#gac7f8a18ca0ca9ebb357b2e7b9c527cc3">UTF8_ERR_NONE</a>)</div><div class="line">    {</div><div class="line">        result = 0;</div><div class="line"></div><div class="line">        <span class="keywordflow">goto</span> cleanup;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((strlen(g_PasswordInput) + strlen(text_input)) &gt; g_PasswordInputMaximum)</div><div class="line">    {</div><div class="line">        result = 0;</div><div class="line"></div><div class="line">        <span class="keywordflow">goto</span> cleanup;</div><div class="line">    }</div><div class="line"></div><div class="line">    strcat(g_PasswordInput, text_input);</div><div class="line"></div><div class="line">cleanup:</div><div class="line">    <span class="keywordflow">if</span> (text_input != NULL)</div><div class="line">    {</div><div class="line">        free(text_input);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> result;</div><div class="line">}</div></div><!-- fragment --><p>With only a few changes, we've upgraded a text field that previously only accepted ASCII to accept the full range of Unicode. And we didn't even have to change the actual algorithm.</p>
<h1><a class="anchor" id="example-display"></a>
Displaying Unicode text</h1>
<p>Even though the user is now able to enter Unicode text, it won't show up right on her screen. That's because the font rendering implementation expects ASCII instead of Unicode.</p>
<p>Let's take a look at the offending function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> InputField_Draw(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keyword">const</span> <span class="keywordtype">char</span>* text)</div><div class="line">{</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* src = text;</div><div class="line">    <span class="keywordtype">size_t</span> i;</div><div class="line"></div><div class="line">    FontBatch_Start(<span class="stringliteral">&quot;Arial20&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; strlen(text); ++i)</div><div class="line">    {</div><div class="line">        FontBatch_AddCharacter(*src);</div><div class="line"></div><div class="line">        src++;</div><div class="line">    }</div><div class="line"></div><div class="line">    FontBatch_End();</div><div class="line">    FontBatch_Draw(x, y);</div><div class="line">}</div></div><!-- fragment --><p>The issue here is that <code>FontBatch_AddCharacter</code> expects code points encoded as one byte per code point. Because UTF-8 is a variable-length encoding, this isn't necessarily true anymore.</p>
<p>In order for the font renderer to display Unicode text, we'll need to convert the UTF-8 encoded text to UTF-32. To that end, we'll use <a class="el" href="group__public.html#ga353e5c4a977a630d154db221d6c36159" title="Convert a UTF-8 encoded string to a UTF-32 encoded string. ">utf8toutf32</a>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> InputField_Draw(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keyword">const</span> <span class="keywordtype">char</span>* text)</div><div class="line">{</div><div class="line">    <span class="keywordtype">size_t</span> text_size = strlen(text);</div><div class="line">    <a class="code" href="group__types.html#gae128fe5bd9e57be736e64d3638229988">unicode_t</a>* converted = NULL;</div><div class="line">    <span class="keywordtype">size_t</span> converted_size;</div><div class="line">    int32_t errors = <a class="code" href="group__errors.html#gac7f8a18ca0ca9ebb357b2e7b9c527cc3">UTF8_ERR_NONE</a>;</div><div class="line">    <span class="keywordtype">size_t</span> i;</div><div class="line">    <a class="code" href="group__types.html#gae128fe5bd9e57be736e64d3638229988">unicode_t</a>* src;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((converted_size = <a class="code" href="group__public.html#ga353e5c4a977a630d154db221d6c36159">utf8toutf32</a>(text, text_size, NULL, 0, &amp;errors)) == 0 ||</div><div class="line">        errors != <a class="code" href="group__errors.html#gac7f8a18ca0ca9ebb357b2e7b9c527cc3">UTF8_ERR_NONE</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">goto</span> cleanup;</div><div class="line">    }</div><div class="line"></div><div class="line">    converted = (<a class="code" href="group__types.html#gae128fe5bd9e57be736e64d3638229988">unicode_t</a>*)malloc(converted_size);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__public.html#ga353e5c4a977a630d154db221d6c36159">utf8toutf32</a>(text, text_size, converted, converted_size, &amp;errors) == 0 ||</div><div class="line">        errors != <a class="code" href="group__errors.html#gac7f8a18ca0ca9ebb357b2e7b9c527cc3">UTF8_ERR_NONE</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">goto</span> cleanup;</div><div class="line">    }</div><div class="line"></div><div class="line">    FontBatch_Start(<span class="stringliteral">&quot;Arial20&quot;</span>);</div><div class="line"></div><div class="line">    src = decoded;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; decoded_size / <span class="keyword">sizeof</span>(<a class="code" href="group__types.html#gae128fe5bd9e57be736e64d3638229988">unicode_t</a>); ++i)</div><div class="line">    {</div><div class="line">        FontBatch_AddCharacter(*src);</div><div class="line"></div><div class="line">        src++;</div><div class="line">    }</div><div class="line"></div><div class="line">    FontBatch_End();</div><div class="line">    FontBatch_Draw(x, y);</div><div class="line"></div><div class="line">cleanup:</div><div class="line">    <span class="keywordflow">if</span> (converted != NULL)</div><div class="line">    {</div><div class="line">        free(converted);</div><div class="line">        converted = NULL;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>After this conversion, the <code>FontBatch_AddCharacter</code> function would have to be modified in order to handle Unicode code points. Fortunately this is a string handling library, not a font rendering one, so I can get away with saying I'm leaving it as an exercise to the reader.</p>
<p>One thing to keep in mind is that even though we convert the entire input string to UTF-32 before rendering it in this example, it's equally valid to read only one codepoint at a time. However, you'll need to use <a class="el" href="group__public.html#gace07c42b3b5031414ceed1f78055242f" title="Seek into a UTF-8 encoded string. ">utf8seek</a> to move the cursor to the next codepoint.</p>
<h1><a class="anchor" id="example-users"></a>
Comparing usernames in a case-insensitive manner</h1>
<p>After the user has entered their username and password, we'll need to verify their identity. This is done on the back-end, with a straightforward function:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>UserData_ {</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* username;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* passwordHash;</div><div class="line">} UserData;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> UserData Users[] = {</div><div class="line">    { <span class="stringliteral">&quot;qlansu&quot;</span>, <span class="stringliteral">&quot;11111&quot;</span> },</div><div class="line">    { <span class="stringliteral">&quot;Admin&quot;</span>, <span class="stringliteral">&quot;ASDFSF&quot;</span> },</div><div class="line">    { <span class="stringliteral">&quot;User1&quot;</span>, <span class="stringliteral">&quot;u99123&quot;</span> }</div><div class="line">};</div><div class="line"></div><div class="line">uint8_t Database_IsUserValid(<span class="keyword">const</span> <span class="keywordtype">char</span>* username, <span class="keyword">const</span> <span class="keywordtype">char</span>* passwordHash)</div><div class="line">{</div><div class="line">    <span class="keywordtype">size_t</span> i;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(Users) / <span class="keyword">sizeof</span>(UserData); ++i)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (!strcmp(Users[i].username, username) &amp;&amp;</div><div class="line">            !strcmp(Users[i].passwordHash, passwordHash))</div><div class="line">        {</div><div class="line">            <span class="keywordflow">return</span> 1;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>Unfortunately, users being users, they end up forgetting the exact combination of upper- and lowercase characters they used for their username.</p>
<p>Luckily, we can use <a class="el" href="group__public.html#gaf50584a0773d99dfb93912b2f29a4c74" title="Remove case distinction from UTF-8 encoded text. ">utf8casefold</a> to do case-insensitive text comparison. Case folding is an operation that erases case distinction between code points. This process allows you to compare and match strings that wouldn't be considered equivalent otherwise.</p>
<p>First, we ensure that the usernames stored in our "database" are casefolded:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> Users[] = {</div><div class="line">    { <span class="stringliteral">&quot;qlansu&quot;</span>, <span class="stringliteral">&quot;11111&quot;</span> },</div><div class="line">    { <span class="stringliteral">&quot;admin&quot;</span>, <span class="stringliteral">&quot;asdfsf&quot;</span> },</div><div class="line">    { <span class="stringliteral">&quot;user1&quot;</span>, <span class="stringliteral">&quot;u99123&quot;</span> }</div><div class="line">};</div></div><!-- fragment --><p>Next, we casefold the incoming string before we compare it to the username:</p>
<div class="fragment"><div class="line">uint8_t Database_IsUserValid(<span class="keyword">const</span> <span class="keywordtype">char</span>* username, <span class="keyword">const</span> <span class="keywordtype">char</span>* passwordHash)</div><div class="line">{</div><div class="line">    uint8_t result;</div><div class="line">    <span class="keywordtype">char</span>* compare_username = NULL;</div><div class="line">    <span class="keywordtype">size_t</span> compare_username_size = 0;</div><div class="line">    int32_t errors;</div><div class="line">    <span class="keywordtype">size_t</span> i;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((compare_username_size = <a class="code" href="group__public.html#gaf50584a0773d99dfb93912b2f29a4c74">utf8casefold</a>(username, strlen(username), NULL, 0, <a class="code" href="group__locales.html#ga0cc6a56588c12c1de734be559a5b0781">UTF8_LOCALE_DEFAULT</a>, &amp;errors)) == 0 ||</div><div class="line">        errors != <a class="code" href="group__errors.html#gac7f8a18ca0ca9ebb357b2e7b9c527cc3">UTF8_ERR_NONE</a>)</div><div class="line">    {</div><div class="line">        result = 0;</div><div class="line"></div><div class="line">        <span class="keywordflow">goto</span> cleanup;</div><div class="line">    }</div><div class="line"></div><div class="line">    compare_username = (<span class="keywordtype">char</span>*)malloc(compare_username_size + 1);</div><div class="line">    <span class="keywordflow">if</span> (compare_username == 0)</div><div class="line">    {</div><div class="line">        result = 0;</div><div class="line"></div><div class="line">        <span class="keywordflow">goto</span> cleanup;</div><div class="line">    }</div><div class="line">    compare_username[compare_username_size] = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__public.html#gaf50584a0773d99dfb93912b2f29a4c74">utf8casefold</a>(username, strlen(username), compare_username, compare_username_size, <a class="code" href="group__locales.html#ga0cc6a56588c12c1de734be559a5b0781">UTF8_LOCALE_DEFAULT</a>, &amp;errors) == 0 ||</div><div class="line">        errors != <a class="code" href="group__errors.html#gac7f8a18ca0ca9ebb357b2e7b9c527cc3">UTF8_ERR_NONE</a>)</div><div class="line">    {</div><div class="line">        result = 0;</div><div class="line"></div><div class="line">        <span class="keywordflow">goto</span> cleanup;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(Users) / <span class="keyword">sizeof</span>(UserData); ++i)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (!strcmp(Users[i].username, compare_username) &amp;&amp;</div><div class="line">            !strcmp(Users[i].passwordHash, passwordHash))</div><div class="line">        {</div><div class="line">            result = 1;</div><div class="line"></div><div class="line">            <span class="keywordflow">goto</span> cleanup;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">cleanup:</div><div class="line">    <span class="keywordflow">if</span> (compare_username != NULL)</div><div class="line">    {</div><div class="line">        free(compare_username);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> result;</div><div class="line">}</div></div><!-- fragment --><p>One thing to keep in mind is that case folding (and uppercasing, lowercasing and titlecasing) are locale-sensitive. That is, their behavior may be changed by the specified locale. Something to keep in mind when dealing with, for example, Turkish or Azerbaijani text. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.12 </li>
  </ul>
</div>
</body>
</html>
